name: Nightly Benchmark Suite
run-name: "Benchmark Suite${{ inputs.start_from && format(' (from: {0})', inputs.start_from) || '' }}"

on:
  schedule:
    - cron: '0 0 * * *'  # Kick off the nightly benchmark queue at midnight UTC
  workflow_dispatch:
    inputs:
      start_from:
        description: 'Start from this benchmark (defaults to first in queue). Queue order: tpch, yakbench, readings, auctionmark, clickbench, tsbs-iot, ingest-tx-overhead, patch, products, ts-devices, fusion'
        required: false
        default: ''
        type: string

permissions:
  contents: read
  actions: write

jobs:
  dispatch:
    if: ${{ github.event_name != 'schedule' || github.repository == 'xtdb/xtdb' }}
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch First Benchmark
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const benchmark = '${{ inputs.start_from }}' || 'tpch';

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: `nightly-benchmark-${benchmark}.yml`,
              ref: context.ref,
              inputs: { run_queue: 'true' }
            });
            core.info(`Dispatched benchmark: ${benchmark}`);
